<html>
  <head>
    <link rel="stylesheet" type="text/css" href="../../stylesheets/project-stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../../stylesheets/syntax.css" media="screen" />
    <title>Matthew Barulic - DIY Autonomous Car</title>
  </head>
    
  <body>
    <header>
      <div class="navigation">
        <a class="navigation" href="../../">Portfolio Home</a>
        <a class="social-links-item github-icon" href="http://www.github.com/barulicm" title="Github" ></a>
        <a class="social-links-item twitter-icon" href="http://twitter.com/mattbarulic" title="Twitter" ></a>
        <a class="social-links-item youtube-icon" href="https://www.youtube.com/user/mattsrobots" title="Youtube" ></a>
      </div>
      
      <div class="personal-bgcolor project-page-section-header">Personal Project</div>
      
      <div class="topimage" style="height: 120px;">
          <img src="../../images/projects/racecar-headerimage.png" id="welcomeimg" />
      </div>
    </header>
        <div class="content">
          <h2 style="text-align: center">DIY Autonomous Car</h2>
          

<p>With only about $200 in parts, anyone can get started exploring the world of self-driving cars. This page provides step-by-step details about how to build this RC-car-based autonomous vehicle.</p>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/xRj47hFZP-0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<h3 id="parts-to-buy">Parts to Buy</h3>

<p>This table lists all of the major components I bought to put the car together. In addition to these parts, you&rsquo;ll need materials for making custom parts (I used a 3D printer), and some screws (listed in the second table).</p>

<h4 id="major-components">Major Components</h4>

<table>
<thead>
<tr>
<th>Part</th>
<th>Vendor</th>
<th>Price</th>
</tr>
</thead>

<tbody>
<tr>
<td><a href="https://hobbyking.com/en_us/turnigy-1-18-4wd-mini-stadium-truck-rtr.html">Turnigy 1 / 18 4WD Mini Stadium Truck (RTR)</a></td>
<td>HobbyKing</td>
<td>$75.15</td>
</tr>

<tr>
<td><a href="https://hobbyking.com/en_us/turnigy-1300mah-2s-20c-lipo-pack-suit-1-18th-truck.html">Turnigy 1300 mAh 2S 20C Lipo Pack</a></td>
<td>HobbyKing</td>
<td>$10.64</td>
</tr>

<tr>
<td><a href="https://hobbyking.com/en_us/turnigy-e3-compact-2s-3s-lipo-charger-100-240v-us-plug.html">Turnigy E3 Compact 2S/3S Lipo Charger (US Plug)</a></td>
<td>HobbyKing</td>
<td>$13.10</td>
</tr>

<tr>
<td><a href="https://hobbyking.com/en_us/hobbykingtm-lipo-voltage-checker-2s-8s.html">HobbyKing Lipo Voltage Checker 2S-8S</a></td>
<td>HobbyKing</td>
<td>$2.11</td>
</tr>

<tr>
<td><a href="https://www.adafruit.com/product/3055">Raspberry Pi - 3 Model B</a></td>
<td>Adafruit</td>
<td>$35.00</td>
</tr>

<tr>
<td><a href="https://www.adafruit.com/product/3099">Raspberry Pi Camera Board v2</a></td>
<td>Adafruit</td>
<td>$29.95</td>
</tr>

<tr>
<td><a href="https://www.adafruit.com/product/2327">Adafruit 16-Channel PWM / Servo Hat</a></td>
<td>Adafruit</td>
<td>$17.50</td>
</tr>

<tr>
<td><a href="https://www.amazon.com/gp/product/B01CU1EC6Y">Anker PowerCore 5000</a></td>
<td>Amazon</td>
<td>$21.99</td>
</tr>

<tr>
<td></td>
<td>Total</td>
<td>$205.44</td>
</tr>
</tbody>
</table>

<h4 id="additional-hardware">Additional Hardware</h4>

<table>
<thead>
<tr>
<th>Part</th>
<th>Quantity</th>
</tr>
</thead>

<tbody>
<tr>
<td>6-32 x 3/8in. Pan Head Screw</td>
<td>10</td>
</tr>

<tr>
<td>M2 x 8mm</td>
<td>4</td>
</tr>

<tr>
<td>M2.5 x 20mm</td>
<td>4</td>
</tr>

<tr>
<td>11mm Plastic Spacer for M2.5 Screw</td>
<td>4</td>
</tr>
</tbody>
</table>

<p>These parts can be found at any big box hardware store for a few dollars.</p>

<p>An alternative to the 11mm spacers and long M2.5 screws is to grab <a href="https://www.adafruit.com/product/2336">Adafruit&rsquo;s brass standoffs for Pi Hats</a> and some shorter M2.5 screws.</p>

<h3 id="assembling-the-hardware">Assembling the Hardware</h3>

<p>To prep the car for additional parts, remove the decorative body and the receiver. Install the battery now, as getting the battery in after the extra parts are added is difficult.</p>

<p>To mount the computing hardware onto the chassis, I designed some custom 3D printed parts which clamp onto the rim around the Turnigy truck&rsquo;s chassis. The parts I downloaded can fit one at a time on the <a href="https://www.monoprice.com/product?p_id=21666">MonoPrice Mini Delta printer</a>, which has a very small build area, so they should fit on just about any 3D printer out there. Once the parts are screwed together, the rim of the car&rsquo;s chassis should fit into the slots on the bottom of the support arches, and the screws next to those slots will clamp the assembly to the car.</p>

<p>You can download the STLs I printed <a href="../../projectfiles/racecar_3dParts.zip">here</a>. (These STLs are in millimeters.)</p>

<p>Once the 3D printed parts are secured, connect the steering servo&rsquo;s PWM cable to the PWM hat&rsquo;s channel 0, and the drive motor cable to channel 1. Pay attention to the channel markings and polarity markings (S,5,G) on the PWM hat.</p>

<h3 id="setting-up-the-raspberry-pi">Setting up the Raspberry Pi</h3>

<p>The Raspberry Pi is a super useful embedded computer, but it does require a bit of setup to work with the hardware we&rsquo;ve got. The first step, if you&rsquo;re new to using the Pi, is to install Raspian, the default operating system. You can do this with the beginner-friendly <a href="https://www.raspberrypi.org/documentation/installation/noobs.md">NOOBS installer</a>.</p>

<p>Once you&rsquo;re in raspian, we need to enable the Camera and I2C kernel modules. You can do this by opening the Raspberry Pi Configuration program from the Preferences menu. On the interfaces tab, enable &ldquo;Camera&rdquo; and &ldquo;I2C&rdquo;. Press OK and restart the Pi to load the modules.</p>

<p>We&rsquo;re going to use three libraries in our code. OpenCV will help us process the image and make intelligent decisions based on what the robot sees. PiPCA9685 is a library I wrote for easily interfacing with Adafruit&rsquo;s PWM shield to control our motors. raspicam (c++) and picamera (python) let us grab images from the camera. Before writing any code, let&rsquo;s get these libraries installed.</p>

<p>OpenCV is a great library, but it can be a bit tricky to install on the Pi. You&rsquo;ll find no shortage of tutorials on how to install it. Here are the commands I used to succesfully install OpenCV 3 on my Pi.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt update <span class="o">&amp;&amp;</span> sudo apt upgrade
sudo apt install build-essential cmake pkg-config libjpeg-dev libtiff5-dev libjasper-dev libpng12-dev libavcodec-dev libavformat-dev libswscale-dev libv4l-dev libxvidcore-dev libx264-dev libgtk2.0-dev libgtk-3-dev libatlas-base-dev gfortran python2.7-dev python3-dev
<span class="nb">cd</span> ~
wget -O opencv.zip https://github.com/opencv/opencv/archive/4.0.1.zip
unzip opencv <span class="o">&amp;&amp;</span> <span class="nb">cd</span> opencv
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release -DCMAKE_INSTALL_PREFIX<span class="o">=</span>/usr/local ..
cmake --build . -- -j4
sudo cmake --build . --target install
sudo ldconfig</code></pre></td></tr></table>
</div>
</div>

<p>If you&rsquo;re working in C++, you&rsquo;ll need raspicam to interact with the camera. You can install it with these commands:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Download raspicam-0.1.6.zip from https://sourceforge.net/projects/raspicam/files/</span>
unzip raspicam-0.1.6.zip <span class="o">&amp;&amp;</span> <span class="nb">cd</span> raspicam-0.1.6
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
cmake ..
cmake –build .
sudo cmake –build . –target install</code></pre></td></tr></table>
</div>
</div>

<p>Raspicam doesn&rsquo;t seem to install itself totally correctly, so if CMake complains that it can&rsquo;t find the raspicam_cv project when you&rsquo;re building your project, try pointing CMake at the raspicam build directory like this:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cmake -Draspicam_DIR<span class="o">=</span>/home/pi/raspicam-0.1.6/build/ ..</code></pre></div>

<p>If you&rsquo;re using Python, instead of getting raspicam, you&rsquo;ll need to get picamera. This can be done with the pip package manager:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">pip install picamera</code></pre></div>

<p>Finally, install PiPCA9685 to get C++ and Python APIs for controlling our motors:</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/barulicm/PiPCA9685.git
<span class="nb">cd</span> PiPCA9685
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
cmake ..
cmake –build . 
sudo cmake –build . –target install
sudo cmake –build . –target python_install</code></pre></td></tr></table>
</div>
</div>

<p><img src="../../images/projects/racecar_20.gif" alt="" /></p>

<h3 id="writing-the-software">Writing the Software</h3>

<p>Alright! It&rsquo;s time to start writing some self-driving car code! Both the C++ and Python exmaples below implement the same approach, so I&rsquo;ll explain it once for the C++ example.</p>

<p>You can download both the C++ and Python code <a href="../../projectfiles/racecar_code.zip">here</a>.</p>

<p>The overall structure of this code is a single loop which grabs the latest image from the camera, uses color matching to identify orange cones, and steers toward the area it can see with the least amount of cones.</p>

<h4 id="c">C++</h4>

<p>For context, here&rsquo;s the entire main.cpp C++ example file.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;opencv2/opencv.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;raspicam/raspicam_cv.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;PiPCA9685/PCA9685.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">auto</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">auto</span> <span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">auto</span> <span class="n">SPEED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">auto</span> <span class="n">STEER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">raspicam</span><span class="o">::</span><span class="n">RaspiCam_Cv</span> <span class="n">Camera</span><span class="p">;</span>
	<span class="n">Camera</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">);</span>
	<span class="n">Camera</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Camera</span><span class="p">.</span><span class="n">open</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Couldn&#39;t open camera.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">PCA9685</span> <span class="n">pca</span><span class="p">;</span>
	<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_freq</span><span class="p">(</span><span class="mf">60.0</span><span class="p">);</span>
	
	<span class="n">cv</span><span class="o">::</span><span class="n">namedWindow</span><span class="p">(</span><span class="s">&#34;Preview&#34;</span><span class="p">,</span> <span class="n">CV_WINDOW_NORMAL</span><span class="p">);</span>
	
	<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">frame_HSV</span><span class="p">;</span>
	<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">filtered</span><span class="p">;</span>
	
	<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">minVal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">maxVal</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	
	<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="n">left_roi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
	<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="n">center_roi</span><span class="p">(</span><span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
	<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="n">right_roi</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
	
	<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">ROIs</span> <span class="o">=</span> <span class="p">{</span><span class="n">left_roi</span><span class="p">,</span> <span class="n">center_roi</span><span class="p">,</span> <span class="n">right_roi</span><span class="p">};</span>
	<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">PWMs</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">};</span>
	<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">nonZeroCounts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	
	<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">);</span>
	<span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="err">&#39;</span><span class="mo">000</span><span class="err">&#39;</span><span class="mo">000</span><span class="p">);</span>
	<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">);</span>
	
	<span class="k">while</span><span class="p">(</span><span class="n">Camera</span><span class="p">.</span><span class="n">grab</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">cv</span><span class="o">::</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Camera</span><span class="p">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
		
		<span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame_HSV</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2HSV</span><span class="p">);</span>
		
		<span class="n">cv</span><span class="o">::</span><span class="n">inRange</span><span class="p">(</span><span class="n">frame_HSV</span><span class="p">,</span> <span class="n">minVal</span><span class="p">,</span> <span class="n">maxVal</span><span class="p">,</span> <span class="n">filtered</span><span class="p">);</span>
		
		<span class="k">auto</span> <span class="n">countFunc</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">filtered</span><span class="p">](</span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="o">&amp;</span><span class="n">roi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">cv</span><span class="o">::</span><span class="n">countNonZero</span><span class="p">(</span><span class="n">filtered</span><span class="p">(</span><span class="n">roi</span><span class="p">));</span>
		<span class="p">};</span>
		
		<span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">ROIs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ROIs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">countFunc</span><span class="p">);</span>
		
		<span class="k">auto</span> <span class="n">minIter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span><span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
		<span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">minIter</span><span class="p">);</span>
		
		<span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">ROIs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
		
		<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">STEER</span><span class="p">,</span> <span class="n">PWMs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>							
		
		<span class="n">cv</span><span class="o">::</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#34;Preview&#34;</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">);</span>
	<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">STEER</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>

<p>And now for a quick section-by-section break down of what this code is doing.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="k">const</span> <span class="k">auto</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
<span class="k">const</span> <span class="k">auto</span> <span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
<span class="k">const</span> <span class="k">auto</span> <span class="n">SPEED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">const</span> <span class="k">auto</span> <span class="n">STEER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
<span class="n">raspicam</span><span class="o">::</span><span class="n">RaspiCam_Cv</span> <span class="n">Camera</span><span class="p">;</span>
<span class="n">Camera</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">);</span>
<span class="n">Camera</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Camera</span><span class="p">.</span><span class="n">open</span><span class="p">())</span> <span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Couldn&#39;t open camera.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="n">PCA9685</span> <span class="n">pca</span><span class="p">;</span>
<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_freq</span><span class="p">(</span><span class="mf">60.0</span><span class="p">);</span>
	
<span class="n">cv</span><span class="o">::</span><span class="n">namedWindow</span><span class="p">(</span><span class="s">&#34;Preview&#34;</span><span class="p">,</span> <span class="n">CV_WINDOW_NORMAL</span><span class="p">);</span>
	
<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">frame</span><span class="p">;</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">frame_HSV</span><span class="p">;</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">filtered</span><span class="p">;</span>
	
<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">minVal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">maxVal</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	
<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="n">left_roi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="n">center_roi</span><span class="p">(</span><span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="n">right_roi</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">);</span>
	
<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">ROIs</span> <span class="o">=</span> <span class="p">{</span><span class="n">left_roi</span><span class="p">,</span> <span class="n">center_roi</span><span class="p">,</span> <span class="n">right_roi</span><span class="p">};</span>
<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">PWMs</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">};</span>
<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">nonZeroCounts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>

<p>This first section simply defines some useful constants, initializes our camera and PCA9685 (the PWM hat), and declares the arrays we&rsquo;ll be working with.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">);</span>
<span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="err">&#39;</span><span class="mo">000</span><span class="err">&#39;</span><span class="mo">000</span><span class="p">);</span>
<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div>

<p>This starts the car driving forward at a constant speed. PWM is a digital signal that communicates a &ldquo;duty cycle&rdquo;. We can treat this like a percentage control over the car&rsquo;s throttle. On the wire, PWM is a square wave where the on time varies from 1.0ms to 2.0ms. The Turnigy truck maps this range as follows.</p>

<p>1.5 -&gt; Full Reverse.</p>

<p>1.7 -&gt; Stopped</p>

<p>2.0 -&gt; Full Forward</p>

<p>As you can see in the code, I&rsquo;m only setting the forward speed to 1.76, or just 20% of the cars max speed. This car can go fast!</p>

<p>The 1 second delay gives the car&rsquo;s ESC time to initialize. It waits for a certain length of neutral (1.7ms) signal before it enables the vehicle.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="k">while</span><span class="p">(</span><span class="n">Camera</span><span class="p">.</span><span class="n">grab</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">cv</span><span class="o">::</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Camera</span><span class="p">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>						
	<span class="c1">// ...
</span><span class="c1"></span>	<span class="n">cv</span><span class="o">::</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#34;Preview&#34;</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>

<p>Here is our main loop, without all of the image processing parts for now. Every iteration, we grab a new image from the camera, check if the user has pressed the spacebar to stop the app, do some processing on the image, and then show it in the preview window.</p>

<div class="highlight"><pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame_HSV</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2HSV</span><span class="p">);</span>
</code></pre></div>

<p>This line converts the image from the BGR colorspace to the HSV colorspace. HSV will make it easier for us to do simple thresholding to highlight all of the orange cones in the track.</p>

<div class="highlight"><pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="n">cv</span><span class="o">::</span><span class="n">inRange</span><span class="p">(</span><span class="n">frame_HSV</span><span class="p">,</span> <span class="n">minVal</span><span class="p">,</span> <span class="n">maxVal</span><span class="p">,</span> <span class="n">filtered</span><span class="p">);</span>
</code></pre></div>

<p>And this line does the actual thresholding by filling the &ldquo;filtered&rdquo; image with 255s where the HSV color was in the range given, and 0 where the color was out of that range.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="k">auto</span> <span class="n">countFunc</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">filtered</span><span class="p">](</span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span> <span class="o">&amp;</span><span class="n">roi</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">cv</span><span class="o">::</span><span class="n">countNonZero</span><span class="p">(</span><span class="n">filtered</span><span class="p">(</span><span class="n">roi</span><span class="p">));</span>
<span class="p">};</span>
		
<span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">ROIs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ROIs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">countFunc</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div>

<p>Here, we define a lambda function which calls countNonZero on the given region of interest (ROI) of the filtered image. Then we use transform to fill the nonZeroCounts array with the number of non-zero pixels in each ROI.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="k">auto</span> <span class="n">minIter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span><span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">nonZeroCounts</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">minIter</span><span class="p">);</span>

<span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">ROIs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">STEER</span><span class="p">,</span> <span class="n">PWMs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</code></pre></td></tr></table>
</div>
</div>

<p>Now that we have the counts for each ROI, we can get the index of the smallest count using min_element and distance. The next two lines draw the rectangle back on the original image for previewing and set the steering PWM to the value corresponding to the direction we want to turn towards.</p>

<p>Similarly to the drive motor, here our PWM values map as follows:</p>

<p>1.5 -&gt; Full left</p>

<p>1.7 -&gt; Straight ahead</p>

<p>2.0 -&gt; Full right</p>

<div class="highlight"><pre class="chroma"><code class="language-CPP" data-lang="CPP"><span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">);</span>
<span class="n">pca</span><span class="p">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">STEER</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">);</span>
</code></pre></div>

<p>Finally, after the loop, we reset the PWM hat to stop the drive motor and set the steering servo to the straight ahead, neutral position. This just makes sure our car doesn&rsquo;t keep running away from us when we stop the app.</p>

<p>And that&rsquo;s all the code it takes to get this car driving around the demo track in the video above.</p>

<h4 id="python">Python</h4>

<p>And here&rsquo;s the entire Python version of the code.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Python" data-lang="Python"><span class="kn">from</span> <span class="nn">picamera</span> <span class="kn">import</span> <span class="n">PiCamera</span>
<span class="kn">from</span> <span class="nn">picamera.array</span> <span class="kn">import</span> <span class="n">PiRGBArray</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">PiPCA9685.PiPCA9685</span> <span class="kn">import</span> <span class="n">PCA9685</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">320</span>
    <span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">240</span>
    <span class="n">STEER</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SPEED</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">camera</span> <span class="o">=</span> <span class="n">PiCamera</span><span class="p">()</span>
    <span class="n">camera</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span><span class="n">HEIGHT</span><span class="p">)</span>
    <span class="n">rawCapture</span> <span class="o">=</span> <span class="n">PiRGBArray</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span><span class="n">HEIGHT</span><span class="p">))</span>

    <span class="c1"># camera warmp up time</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA9685</span><span class="p">()</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">set_pwm_freq</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Preview&#39;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>

    <span class="n">minVal</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">maxVal</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="n">ROIs</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="n">WIDTH</span><span class="o">//</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">HEIGHT</span><span class="p">)],</span>
             <span class="p">[(</span><span class="n">WIDTH</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">WIDTH</span><span class="o">//</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)],</span>
             <span class="p">[(</span><span class="mi">2</span><span class="o">*</span><span class="n">WIDTH</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)]</span> <span class="p">]</span>

    <span class="n">PWMs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>

    <span class="n">pca</span><span class="o">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">capture</span> <span class="ow">in</span> <span class="n">camera</span><span class="o">.</span><span class="n">capture_continuous</span><span class="p">(</span><span class="n">rawCapture</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;bgr&#39;</span><span class="p">,</span> <span class="n">use_video_port</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">capture</span><span class="o">.</span><span class="n">array</span>

        <span class="n">frame_HSV</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>

        <span class="n">filtered</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">frame_HSV</span><span class="p">,</span> <span class="n">minVal</span><span class="p">,</span> <span class="n">maxVal</span><span class="p">)</span>

        <span class="n">minCount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">minIdx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROIs</span><span class="p">)):</span>
            <span class="n">ROI</span> <span class="o">=</span> <span class="n">ROIs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">countNonZero</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">minCount</span><span class="p">:</span>
                <span class="n">minCount</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">minIdx</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">minROI</span> <span class="o">=</span> <span class="n">ROIs</span><span class="p">[</span><span class="n">minIdx</span><span class="p">]</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">minROI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">minROI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">minROI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">minROI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">pca</span><span class="o">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">STEER</span><span class="p">,</span> <span class="n">PWMs</span><span class="p">[</span><span class="n">minIdx</span><span class="p">])</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Preview&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">rawCapture</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">pca</span><span class="o">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">SPEED</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">)</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">set_pwm_ms</span><span class="p">(</span><span class="n">STEER</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>

        </div>
  </body>
</html>